<div class="top">
  <button (click)="newGame()">New Game</button>
  <h2>{{ header }}</h2>
  <p>{{ remaining }}</p>
</div>

<div id="game-area">
  <div class="captured computer">
    <h4>Computer</h4>
    <div class="deck-row">
      <div class="stack" aria-hidden="true">
         <div class="stack-card" *ngFor="let _ of computerCapturedStack; let i = index"
           [style.transform]="'translate(-50%,-50%) translateY(-' + (i * 1.5) + 'px)'"
           [style.zIndex]="i"></div>
      </div>
      <div class="count">{{ computerDeck.length }}</div>
    </div>
    <div class="war-visual-slot">
      <div class="war-visual" *ngIf="lastBattleWasWar && warPlaced">
        <div class="card-back small" *ngFor="let n of [1,2,3]"></div>
      </div>
    </div>
  </div>

    <div id="cards">
      <div class="card-slot" *ngIf="!lastBattleWasWar" [style.visibility]="battleStage === 'animating' ? 'hidden' : 'visible'">
        <div class="flip-card" [class.flipped]="flipCards.left">
          <div class="flip-inner">
            <div class="flip-front" *ngIf="images[0]" [style.backgroundImage]="'url(' + images[0] + ')'">
            </div>
            <div class="flip-back"></div>
          </div>
        </div>
      </div>
      <div class="war-center" *ngIf="lastBattleWasWar" [style.visibility]="battleStage === 'animating' ? 'hidden' : 'visible'">
      <ng-container *ngIf="warPhase === 'facedown'">
        <div class="vs-overlay">WAR</div>
        <div class="war-card-slot">
          <div class="flip-card" [class.flipped]="true">
            <div class="flip-inner">
              <div class="flip-front" *ngIf="images[0]" [style.backgroundImage]="'url(' + images[0] + ')'">
              </div>
              <div class="flip-back"></div>
            </div>
          </div>
        </div>
        <div class="war-card-slot">
          <div class="flip-card" [class.flipped]="true">
            <div class="flip-inner">
              <div class="flip-front" *ngIf="images[1]" [style.backgroundImage]="'url(' + images[1] + ')'">
              </div>
              <div class="flip-back"></div>
            </div>
          </div>
        </div>
      </ng-container>
      <ng-container *ngIf="warPhase === 'reveal'">
        <div class="reveal-overlay">REVEAL</div>
        <div class="war-card-slot">
          <div class="flip-card" [class.flipped]="true">
            <div class="flip-inner">
              <div class="flip-front" *ngIf="images[0]" [style.backgroundImage]="'url(' + images[0] + ')'">
              </div>
              <div class="flip-back"></div>
            </div>
          </div>
        </div>
        <div class="war-card-slot">
          <div class="flip-card" [class.flipped]="true">
            <div class="flip-inner">
              <div class="flip-front" *ngIf="images[1]" [style.backgroundImage]="'url(' + images[1] + ')'">
              </div>
              <div class="flip-back"></div>
            </div>
          </div>
        </div>
      </ng-container>
        </div>

        <div class="card-slot" *ngIf="!lastBattleWasWar" [style.visibility]="battleStage === 'animating' ? 'hidden' : 'visible'">
      <div class="flip-card" [class.flipped]="flipCards.right">
        <div class="flip-inner">
          <div class="flip-front" *ngIf="images[1]" [style.backgroundImage]="'url(' + images[1] + ')'">
          </div>
          <div class="flip-back"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="captured player">
    <h4>You</h4>
    <div class="deck-row">
      <div class="count">{{ playerDeck.length }}</div>
      <div class="stack" aria-hidden="true">
         <div class="stack-card" *ngFor="let _ of playerCapturedStack; let i = index"
           [style.transform]="'translate(-50%,-50%) translateY(-' + (i * 1.5) + 'px)'"
           [style.zIndex]="i"></div>
      </div>
    </div>
    <div class="war-visual-slot">
      <div class="war-visual" *ngIf="lastBattleWasWar && warPlaced">
        <div class="card-back small" *ngFor="let n of [1,2,3]"></div>
      </div>
    </div>
  </div>
</div>

<div class="controls">
  <button class="draw" (click)="nextStep()" [disabled]="drawDisabled || inBattle || autoPlay">{{ battleStage === 'idle' ? 'Draw' : 'Next' }}</button>
  <button class="auto" (click)="toggleAutoPlay()">{{ autoPlay ? 'Stop' : 'Auto' }}</button>
  <label style="margin-left:8px">Speed:</label>
  <input type="range" min="2" max="400" step="1" [(ngModel)]="autoStepDelayMs" />
  <span>{{autoStepDelayMs}}ms</span>
  <label class="toggle-label"><input type="checkbox" [(ngModel)]="fastSim" [disabled]="autoPlayRunning"><span class="toggle-slider"></span> Fast Sim</label>
</div>

<div class="anim-layer" *ngIf="animatingCards.length">
  <div *ngFor="let c of animatingCards"
       class="anim-card"
       [ngStyle]="c.style"
       (transitionend)="onAnimTransitionEnd(c.id)">
  </div>
</div>

<!-- Confetti overlay -->
<div class="confetti-overlay" *ngIf="showConfetti">
  <span *ngFor="let p of confettiArray; let i = index"
        class="confetti-piece"
        [style.left.%]="p"
        [style.background]="(i % 3 === 0) ? '#FF5E5B' : (i % 3 === 1) ? '#FFB400' : '#4CD97B'"
        [style.animationDelay]="(i * 60) + 'ms'">
  </span>
</div>
